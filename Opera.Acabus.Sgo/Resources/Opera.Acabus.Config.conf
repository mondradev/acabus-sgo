<?xml version="1.0" encoding="utf-8" ?> 
<configuration>
	<Owner name="OPERA" />
	<App Token="[API_Key]" DeviceKey="[Device_Key]" />
	<Message Rules="Resources/Opera.Acabus.MessageDefinition.json" />
	<connectionDb assembly="Libraries/System.Data.SQLite.dll" type="System.Data.SQLite.SQLiteConnection" assemblyDialect="Libraries/Opera.Acabus.DatabaseController.dll" typeDialect="Opera.Acabus.DatabaseController.SQLiteDialect" connectionString="Data Source=Resources/Opera.Acabus.Data.db;Password=acabus*data*dat" />
	<Server IP="172.17.0.12" Port="5500" Push_Port="5501" />

	<AssignableSections>
		<AssignableSection Description="ZÓCALO/OVIEDO - LAS ANCLAS" />
		<AssignableSection Description="DR. IGNACIO CHÁVEZ -  CENTRAL DE ABASTOS" />
	</AssignableSections>

	<modules>
		<module assembly="Opera.Acabus.Core.Config.dll" fullname="Opera.Acabus.Core.Config.CoreConfigModule" />
		<module assembly="Opera.Acabus.Server.Config.dll" fullname="Opera.Acabus.Server.Config.ServerCoreModule" />
	</modules>
	
	<queryCheckReply>
		<KVR value="select coalesce(sum(pending), 0) pending, min(fch_min) fch_min from ( select 'Tran' des, count(*) pending, min(fch_envi) fch_min from sitm_envi.sbop_tran where bol_envi=false group by des union select 'Tran_Divi' des, count(*) pending, min(fch_envi) fch_min from sitm_envi.sbop_tran_divi where bol_envi=false group by des union select 'Reca' des, count(*) pending, min(fch_envi) fch_min from sitm_envi.sbop_reca where bol_envi=false group by des union select 'Reca_Divi' des, count(*) pending, min(fch_envi) fch_min from sitm_envi.sbop_reca_divi where bol_envi=false group by des ) as pendings" />
		<PMR value="select coalesce(sum(pending), 0) pending, min(fch_min) fch_min from ( select 'Acce_Sali' des, count(*) pending, min(fch_envi) fch_min from sitm_envi.sbop_acce_sali where bol_envi=false group by des union select 'Turn' des, count(*) pending, min(fch_envi) fch_min from sitm_envi.sbop_turn where bol_envi=false group by des ) as pendings" />
		<TD value="select coalesce(sum(pending), 0) pending, min(fch_min) fch_min from ( select 'Acce_Sali' des, count(*) pending, min(fch_envi) fch_min from sitm_envi.sbop_acce_sali where bol_envi=false group by des union select 'Turn' des, count(*) pending, min(fch_envi) fch_min from sitm_envi.sbop_turn where bol_envi=false group by des ) as pendings" />
		<TS value="select coalesce(sum(pending), 0) pending, min(fch_min) fch_min from ( select 'Acce_Sali' des, count(*) pending, min(fch_envi) fch_min from sitm_envi.sbop_acce_sali where bol_envi=false group by des union select 'Turn' des, count(*) pending, min(fch_envi) fch_min from sitm_envi.sbop_turn where bol_envi=false group by des ) as pendings" />
		<TSI value="select coalesce(sum(pending), 0) pending, min(fch_min) fch_min from ( select 'Acce_Sali' des, count(*) pending, min(fch_envi) fch_min from sitm_envi.sbop_acce_sali where bol_envi=false group by des union select 'Turn' des, count(*) pending, min(fch_envi) fch_min from sitm_envi.sbop_turn where bol_envi=false group by des ) as pendings" />
	</queryCheckReply>
	
	<serverCC connectionString="User ID=postgres;Password=admin;Host=172.17.0.121;Port=5432;Database=SITM;CommandTimeout=0">
		<downloadFromServer>
			<buses value="select vehi.id_vehi id, vehi.id_tipo_vehi as type, vehi.no_econ economicnumber, coalesce((select id_lin from ( select distinct id_lin_est from ( select id_equi, id_turn, count(*) from sitm.sbop_acce_sali where id_equi in (select id_equi from sitm.sbeq_equi where no_econ=vehi.no_econ) and date(fch_acce_sali) in (select date(max(fch_acce_sali)) from sitm.sbop_acce_sali where id_equi in (select id_equi from sitm.sbeq_equi where no_econ=vehi.no_econ)) group by id_equi, id_turn ) turnos left join sitm.sbop_asgn_turn asgn on turnos.id_equi=asgn.id_equi and turnos.id_turn=asgn.id_turn) asgn left join sitm.sfln_lin_est le on le.id_lin_est=asgn.id_lin_est limit 1),2) idroute from sitm.sfvh_vehi vehi where id_esta=1" />
			<devices value="select id_equi id, nume_seri as serial, dir_ip ip, (select id_est from sitm.sfln_lin_est where id_lin_est=e.id_lin_est) idstation, (select id_vehi from sitm.sfvh_vehi where no_econ=e.no_econ) idbus, (select regexp_matches(nume_seri,'CDE|TSI|TD|TS|KVR|PMR|PCA'))[1] as type from sitm.sbeq_equi e where (select regexp_matches(upper(nume_seri), 'TSI|TD|TS|KVR|PMR|PCA|CDE')) is not null union select cast(substring(nume_seri from 6 for 8) as integer) id, nume_seri as serial, '0.0.0.0' ip, cast(substring(nume_seri from 10 for 2) as integer) idStation, null idBus, 'DSPL' as type from sitm.cctm_inv where (select regexp_matches(upper(nume_seri), 'DS')) is not null order by id" />
			<routes value="select id_lin id, (select regexp_matches(nom, '[0-9]+'))[1] number, substring(nom from position('-' in nom)+1) as name, case when id_tipo_lin=190 then 'TRUNK' when id_tipo_lin=191 then 'ALIM' else 'none' end as type from sitm.sfln_lin where id_esta=1 and id_tipo_lin in (190, 191) order by id_lin asc" />
			<stations value="select e.id_est id, nom_est as name, no_est number, id_lin idroute from sitm.sfes_est e left join sitm.sfln_lin_est le on le.id_est=e.id_est where e.id_esta=1 and tran=154 and e.id_tipo=4 order by number" />
		</downloadFromServer>
	</serverCC>

	<Cctv>
		<business>
			<business value="OPERA"/>
			<business value="GUARDIAS" />
			<business value="TRANSPORTISTA" />
			<business value="OPD" />
		</business>
		<refundOfMoney Money="11" Bill="14" />
		<reports>
			<report description="Incidencias" query="select folio, fc.name categoría, f.description descripción, whoreporting quién_reporta, coalesce(s.name, v.economicnumber) ubicación, coalesce(d.serialnumber, case when d.type = 17 then 'torniquete abordo' when d.type = 19 then 'monitor' when d.type = 13 then 'display bus' when d.type = 15 then 'contador de pasajeros' when d.type = 16 then 'grabador de video móvil' when d.type = 18 then 'cámara' end) equipo, startdate fecha_incidencia, finishdate fecha_solución, case when i.status = 0 then 'abierta' when i.status = 1 then 'cerrada' when i.status = 2 then 'por confirmar' when i.status = 3 then 'pendiente' else 'desconocida' end estado, at.name asignación, t.name técnico_solución, observations observaciones, r.quantity cantidad, case when cd.cashtype = 0 then 'monedas' when cd.cashtype = 1 then 'billete' end tipo_dinero, cd.description enviado_a, r.refunddate fecha_devolución from incidences i left join faults f on i.fk_fault_id = f.id left join faultcategories fc on fc.id = f.fk_faultcategories_id left join devices d on d.id = i.fk_device_id left join stations s on s.id = d.fk_station_id left join buses v on v.id = d.fk_bus_id left join ( select a.id, t.name from assignablestaff a left join staff t on t.id = a.fk_Staff_id ) at on at.id = i.fk_assignablestaff_id left join staff t on i.fk_staff_id = t.id left join refundofmoney r on r.fk_incidence_folio = i.folio left join cashdestinies cd on cd.id = r.fk_cashdestiny_id where date(i.startdate) between date('{0:yyyy-MM-dd}') and date('{1:yyyy-MM-dd}')" />
		</reports>
	</Cctv>
	
</configuration>